<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ODP 2025</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="/api/placeholder/150/150" alt="Logo" class="logo" id="logo">
            </div>
            <button class="progress-btn" id="progressBtn">Progresso</button>
        </div>
        
        <div class="card" id="content">
            <div class="content">
                <h1 class="title" id="title"></h1>
                <div class="text" id="text"></div>
                <button class="log-btn" id="logBtn">Segna come completato</button>
            </div>
        </div>
        
        <div class="not-found" id="notFound" style="display: none;">
            <h2>Errore</h2>
            <p>Non è stato possibile recupeare la tappa, riprova!</p>
        </div>
    </div>

    <!-- Modal for Progress -->
    <div id="progressModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Il tuo progresso</h2>
                <span class="close">&times;</span>
            </div>
            
            <div id="progressSummary" class="progress-summary">
                <!-- Progress summary will be inserted here -->
            </div>
            
            <div class="timeline" id="timelineProgress">
                <!-- Timeline items will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        // Get content data from JSON file
        let contentData = [];
        let currentContent = null;

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        function formatDate(date) {
            const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(date).toLocaleDateString('en-US', options);
        }

        // Function to display content based on ID
        function displayContent(id) {
            const content = contentData.find(item => item.Id === parseInt(id));
            
            if (content) {
                currentContent = content;
                document.getElementById('logo').src = content.ImageSrc || '/api/placeholder/150/150';
                document.getElementById('title').textContent = content.Title;
                document.getElementById('text').textContent = content.Text;
                document.getElementById('content').style.display = 'block';
                document.getElementById('notFound').style.display = 'none';
            } else {
                document.getElementById('content').style.display = 'none';
                document.getElementById('logBtn').style.display = 'none';
                document.getElementById('notFound').style.display = 'block';
            }
        }

        // Function to log completed content to local storage
        function logCompletedContent() {
            if (!currentContent) return;
            
            let completed = JSON.parse(localStorage.getItem('completedContent')) || [];
            
            // Check if already completed
            if (!completed.some(item => item.Id === currentContent.Id)) {
                // Add timestamp to the completed item
                const completedItem = {
                    ...currentContent,
                    completedAt: new Date().toISOString()
                };
                completed.push(completedItem);
                localStorage.setItem('completedContent', JSON.stringify(completed));
                // Create notification instead of alert
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.backgroundColor = '#e6007e';
                notification.style.color = 'white';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '8px';
                notification.style.boxShadow = '0 4px 10px rgba(230, 0, 126, 0.2)';
                notification.style.zIndex = '1000';
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                notification.textContent = 'Tappa completata!';
                
                document.body.appendChild(notification);
                
                // Show notification
                setTimeout(() => {
                    notification.style.opacity = '1';
                }, 10);
                
                // Hide and remove notification
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
                
                updateProgressList();
            } else {
                // Alert for already completed
                const notification = document.createElement('div');
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.left = '50%';
                notification.style.transform = 'translateX(-50%)';
                notification.style.backgroundColor = '#6c757d';
                notification.style.color = 'white';
                notification.style.padding = '10px 20px';
                notification.style.borderRadius = '8px';
                notification.style.boxShadow = '0 4px 10px rgba(0,0,0,0.2)';
                notification.style.zIndex = '1000';
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                notification.textContent = 'Hai già completato questa tappa!';
                
                document.body.appendChild(notification);
                
                // Show notification
                setTimeout(() => {
                    notification.style.opacity = '1';
                }, 10);
                
                // Hide and remove notification
                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }
        }

        // Function to update progress list in modal
        function updateProgressList() {
            const timelineProgress = document.getElementById('timelineProgress');
            timelineProgress.innerHTML = '';
            
            const progressSummary = document.getElementById('progressSummary');
            progressSummary.innerHTML = '';
            
            const completed = JSON.parse(localStorage.getItem('completedContent')) || [];
            
            // Update progress summary
            const totalItems = contentData.length;
            const completedItems = completed.length;
            const completionPercentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
            
            progressSummary.innerHTML = `
                <div class="progress-stat">
                    <div class="progress-stat-number">${completedItems}</div>
                    <div class="progress-stat-label">Completati</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-number">${totalItems}</div>
                    <div class="progress-stat-label">Totali</div>
                </div>
                <div class="progress-stat">
                    <div class="progress-stat-number">${completionPercentage}%</div>
                    <div class="progress-stat-label">% Completato</div>
                </div>
            `;
            
            if (completed.length === 0) {
                timelineProgress.innerHTML = '<div class="timeline-empty">Nessun progresso, completa delle tappe per visualizzarlo!</div>';
                return;
            }
            
            // Sort completed items by completion date (newest first)
            completed.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
            
            completed.forEach(item => {
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                
                const formattedDate = item.completedAt ? formatDate(item.completedAt) : 'Date unknown';
                
                timelineItem.innerHTML = `
                    <div class="timeline-dot"></div>
                    <span class="timeline-date">${formattedDate}</span>
                    <div class="timeline-content">
                        <div class="timeline-title">${item.Title}</div>
                        <div class="timeline-text">${item.Text.substring(0, 100)}${item.Text.length > 100 ? '...' : ''}</div>
                    </div>
                `;
                
                timelineProgress.appendChild(timelineItem);
            });
        }

        // Event listeners
        document.getElementById('logBtn').addEventListener('click', logCompletedContent);
        
        // Modal functionality
        const modal = document.getElementById('progressModal');
        const btn = document.getElementById('progressBtn');
        const span = document.getElementsByClassName('close')[0];

        // Fetch the JSON data
        fetch('data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                contentData = data;
                const id = getUrlParameter('id');
                if (id) {
                    displayContent(id);
                } else {
                    updateProgressList();
                    document.getElementById('content').style.display = 'none';
                    modal.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('content').style.display = 'none';
                document.getElementById('notFound').style.display = 'block';
                document.getElementById('notFound').innerHTML = '<h2>Error Loading Data</h2><p>There was a problem loading the content data. Please try again later.</p>';
            });

        
        btn.onclick = function() {
            updateProgressList();
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
        }
        
        span.onclick = function() {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Restore scrolling
        }
        
        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restore scrolling
            }
        }
    </script>
</body>
</html>